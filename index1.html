<html>
<head>
	<title>LetsWatch</title>
	<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
	<style>
		*, *:before, *:after {
			box-sizing: border-box;
			margin: 0;
			padding: 0;
		}

		body {
			background-color: #f9effe;
		}

		#chat{
			height: 300px;
			background-color: white;
			overflow-y: auto;
			overflow-x: hidden;
			padding: 0 5px;
			padding-bottom: 10px;
			font-family: Arial;
		}

		#contentWrap {
			width: 720px;
			margin: 0 auto;
			display: none;
			flex-direction: column;
		}

		#chatWrap{
			width: 520px;
		}

		#users {
			width: 200px;
			background-color: white;
			padding: 0 10px;
			border-left: 1px solid #aaa;
			font-family: Arial;
		}

		.error{
			color: red;
		}

		.whisper{
			color: gray;
			font-style: italic;
		}

		#send-message {
			overflow: hidden;
			white-space: nowrap;
		}

		#message {
			width: 720px;
			height: 50px;
			padding: 10px;
			border: 1px solid #aaa;
			border-top: 0;
		}

		button.send {
			height: 50px;
			width: 100px;
			margin-left: -104px;
		}

		#search {
			width: 720px;
			height: 50px;
			padding: 15px;
			font-size: 17pt;
			border: 1px solid #ccc;
		}

		#searchForm {
			width: 720px;
			overflow: hidden;
			margin: 10px 0;
			white-space: nowrap;
		}

		button.icon {
			width: 50px;
			height: 50px;
			margin-left: -54px;
			position: relative;
			top: 2px;
			padding: 15px;
			border: 1px solid #ccc;
			font-size: 17pt;
		}

		#results {
			height: 100%;
			width: 370px;
			position: absolute;
			top: 0;
			left: 0;
			transform: translateX(-100%);
			transition: all 0.25s;
			background: #222;
			overflow-y: auto;
		}

		.resultThumbnails {
			/*display: inline;*/
		}

		.resultContainer {
			padding: 25px;
			padding-top: 20px;
			padding-bottom: 40px;
			cursor: pointer;
		}

		.resultContainer:hover {
			background: #444;
		}

		h3 {
			font-family: Arial, sans;
			color: #fff;
			text-align: center;
			margin-bottom: 10px;
		}

		#mainWrap {
			width: 720px;
			display: flex;
			border: 1px solid #aaa;
		}
	</style>
</head>
<body>
	<div id="nickWrap">
		<p>Enter a username:</p>
		<p id="nickError"></p>
		<form id="setNick">
			<input size="35" id="nickname"></input>
			<input type="submit"></input>
		</form>
	</div>

	<div id="contentWrap">
		<form id="searchForm">
			<input type="text" id="search" placeholder="Search for a video or enter URL..."></input>
			<button class="icon"><i class="fa fa-search"></i></button>
		</form>
		<div id="results">
			
		</div>
		<div id="player">
		</div>
		<div id="mainWrap">
			<div id="chatWrap">
				<div id="chat"></div>
			</div>
			<div id="users"></div>	
		</div>
		<form id="send-message" autocomplete="off">
			<input size="35" id="message"></input>
			<button class="send">Send</button>
		</form>
	</div>
	
	<script src="http://code.jquery.com/jquery-latest.min.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<script src="https://www.youtube.com/iframe_api"></script>
	<script> 

	var socket = io.connect();
	
	//YouTube iFrame Player API
	// 2. This code loads the IFrame Player API code asynchronously.
	      var tag = document.createElement('script');
	      tag.src = "https://www.youtube.com/iframe_api";
	      var firstScriptTag = document.getElementsByTagName('script')[0];
	      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

	      // 3. This function creates an <iframe> (and YouTube player)
	      //    after the API code downloads.
	    	var player = undefined,
	    		cue = [];

	      var playerStates = {
	      	unstarted: -1, 
	      	ended: 0,
	      	playing: 1,
	      	paused: 2,
	      	buffering: 3,
	      	videoCued: 5
	      }

	    function onYouTubeIframeAPIReady() {
	      	player = new YT.Player('player', {
				height: '390',
				width: '720',
				videoId: cue[0],
				playerVars: {
					'controls': 0,
					'rel': 0,
					'disablekb': 1,
					'modestbranding': 1
				},
				events: {
				'onReady': onPlayerReady,
				'onStateChange': onPlayerStateChange
				}
			});
	 	}

	    // 4. The API will call this function when the video player is ready.
	    function onPlayerReady(event) {
	      	// setTimeout(handler, 3000);
		}

	      // 5. The API calls this function when the player's state changes.
	      //    The function indicates that when playing a video (state=1),
	      //    the player should play for six seconds and then stop.

	      // Pause, change time

	function onPlayerStateChange(event) {

		switch(player.getPlayerState()) {
	    	case -1:
	      		console.log("unstarted")
	      		break;
	      	case 0:
	      		console.log("ended")
	      		socket.emit('play next video', cue)
	      		break;
	      	case 1:
	      		console.log("play")
	      		socket.emit('play video')
	      		break;
	      	case 2:
	      		console.log("pause")
	      		socket.emit('pause video')
	      		break;
	      	case 3:
	      		console.log("buffering")
	      		break;
	      	case 5:
	      		console.log("video cued")
	    }
	}
	      
	function handler() {
		console.log("Handler called - client side cue", cue)
		if (player && cue.length > 0)  {
			var id = cue.shift()
			console.log(id)
      		player.loadVideoById(id)
			player.playVideo()
			console.log("After cue shift - client side cue", cue)
		}
		else {
			player.stopVideo();
			console.log("No videos in client side cue")
		}
	}

	// function playVideoNow(id) {
	// 	player.loadVideoById(id)
	// 	player.playVideo()
	// }

	function addToCue(id, callback) {
		cue.push(id)
		if (callback)
			callback();
		else
			return
	}

	function stopVideo() {
		player.stopVideo()
	} 

	function getVideoDuration() {
		return player.getDuration()
	}
	
		jQuery(function($) {
			
			var $nickForm = $('#setNick'),
				$nickError = $('#nickError'),
				$nickBox = $('#nickname'),
				$users = $('#users'),
				$messageForm = $('#send-message'),
				$messageBox = $('#message'),
				$chat = $('#chat'),
				$player = $('#player'),
				$searchForm = $('#searchForm'),
				$searchQuery = $('#search'),
				$results = $('#results'),
				$resultVideo = $('.resultThumbnails'),
				resultsWindow = false;

			// Ajax calls to YouTube API

			$searchForm.submit(function(e) {
				e.preventDefault();
				$.ajax({
					url: 'https://www.googleapis.com/youtube/v3/search?q=' + $searchQuery.val() + '&part=snippet&key=AIzaSyCt8JA0ZFnQ2F9qBBVN1ZyjMxxz5pMEthc'
				}).done(function(data) {
					$results.html('');
					data.items.map(function(video) {
						if (video.id.videoId === undefined) {
							return
						}
						// console.log(video.id.videoId); videoID
						// console.log(video.snippet.thumbnails.default.url); videoThumbnail
						$results.append('<div class="resultContainer" id="' + video.id.videoId + '" title="' + video.snippet.title + '"><h3>' + video.snippet.title + '</h3><img class="resultThumbnails" src="' + video.snippet.thumbnails.medium.url + '"></div>');
						$results.css("transform", "translateX(0)");
						resultsWindow = true;
					});
				})
			});

			// Possibly bad performance having event handler on whole document - change?

			$(document).on('click', function() {
				console.log(resultsWindow)
				if (resultsWindow)
					$results.css("transform", "translateX(-100%)");
					resultsWindow = false
				return
			});

			// When result video is clicked

			$results.on('click', '.resultContainer', function() {
				var videoId = this.id,
					videoTitle = this.title;
				socket.emit('new video', {id: videoId, title: videoTitle});
				$results.css("transform", "translateX(-100%)");
			});

			// When nick form is submitted

			$nickForm.submit(function(e) {
				e.preventDefault();
				handler();
				socket.emit('new user', $nickBox.val(), function(data) {
					if (data) {
						$('#nickWrap').css("display", "none");
						$('#contentWrap').css("display", "flex");
					} else {
						$nickError.html('That username is already taken!  Try again.');
					}
				});
				$nickBox.val('');
			});

			socket.on('user join', function(data) {
				$chat.append(data.nick + ' has entered the room</br>')
				$chat.scrollTop(document.getElementById("chat").scrollHeight);
			});

			socket.on('user leave', function(data) {
				$chat.append(data.nick + ' has left the room</br>');
				$chat.scrollTop(document.getElementById("chat").scrollHeight);
			});			
			
			socket.on('usernames', function(data) {
				var html = '';
				for(i=0; i < data.length; i++) {
					html += data[i] + '<br/>'
				}
				$users.html(html);
			});
			
			$messageForm.submit(function(e) {
				e.preventDefault();
				socket.emit('send message', $messageBox.val(), function(data) {
					$chat.append('<span class="error">' + data + "</span><br/>");
				});
				$messageBox.val('');
			});

			socket.on('change video', function(data) {
				if (!cue.length ||
					!player.getPlayerState() === 1 || 
					!player.getPlayerState() === 2 || 
					player.getPlayerState() === 0 || 
					// player.getPlayerState() === -1 ||
					player.getPlayerState() === 5) {
					addToCue(data.id, handler)
					console.log(cue)
				} else {
					addToCue(data.id)
				}
				$chat.append('<span class="whisper"><b>' + data.nick + '</b> added <b>' + data.title + '</b> to the cue</span><br/>');
				$chat.scrollTop(document.getElementById("chat").scrollHeight);
			});
			
			socket.on('new message', function(data) {
				var str = (data.nick + ': ' + data.msg),
					br = document.createElement("br");
				$chat.append(document.createTextNode(str));
				$chat.append(br);
				$chat.scrollTop(document.getElementById("chat").scrollHeight);
			});

			socket.on('pause video', function() {
				player.pauseVideo();
				console.log("pause video serverside")
			});

			socket.on('play video', function() {
				player.playVideo();
				console.log("play video serverside")
			});

			socket.on('send cue', function(data) {
				cue = data.cue
			});

			socket.on('next video', function() {
				handler();
			});
		});
	</script>
</body>
</html>